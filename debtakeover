#!/bin/sh -x
#
# debtakeover
#
# Convert a new non-Debian distribution to Debian proper
#
# $Id: debtakeover,v 1.2 2003/07/19 12:40:31 guillem Exp $
#

DEBIAN_MIRROR=http://ftp.no.debian.org
DEBIAN_VERSION=$1
shift

ETC_EXCLUDES="mtab fstab hostname hosts resolv.conf lilo.conf modules
        modules.conf ssh/ssh_host_*"

DEBOOTSTRAP=./debootstrap
DEBOOTSTRAP_INCLUDES="ssh,grub,libssl0.9.6,zlib1g"
if [ "$DEBTAKEOVER_PROFILE" = "colo"  ]; then
  DEBOOTSTRAP_EXCLUDES="setserial,fdutils,ipchains,pcmcia-cs,ppp,pppconfig,\
pppoe,pppoeconf"
else
  DEBOOTSTRAP_EXCLUDES=""
fi

setup_chroot()
{
  mount /proc

  sed -e 's/^FSCKFIX=no/FSCKFIX=yes/;s/^TMPTIME=0/TMPTIME=15/' \
    < /etc/defaults/rcS > /tmp/rcS && mv -f /tmp/rcS /etc/defaults/

  for f in $ETC_EXCLUDES; do
    rm -f /etc/$f
  done

  rm /var/lib/apt/lists/*_{Sources,Packages,Release}
  rm /var/cache/apt/{*.bin,archives/*.deb}

  if [ "$DEBTAKEOVER_PROFILE" = "colo"  ]; then
    mv -f /sbin/halt /sbin/reboot
    rm /etc/rc0.d/S90halt
    rm /etc/rc1.d/*
    cp /etc/rc6.d/S90reboot /etc/rc0.d
    cp /etc/rc2.d/* /etc/rc1.d

    rmdir /cdrom /floppy
  fi

  dpkg-reconfigure -s base-passwd passwd

  rm -rf /dev
  update-inetd --multi --disable discard,daytime,time

  umount /proc

  exit 0
}

stage_tarball()
{
  echo "Stage (Building the base-tarball)"
  echo "-----"

  $DEBOOTSTRAP --include="$DEBOOTSTRAP_INCLUDES" \
    --exclude="$DEBOOTSTRAP_EXCLUDES" \
        $DEBIAN_VERSION $DEBIAN_VERSION-tarball $DEBIAN_MIRROR/debian

  cat > $DEBIAN_VERSION-tarball/etc/apt/sources.list <<-EOF
  deb $DEBIAN_MIRROR/ $DEBIAN_VERSION/updates main
  deb $DEBIAN_MIRROR/debian $DEBIAN_VERSION main
  deb $DEBIAN_MIRROR/debian-non-US $DEBIAN_VERSION/non-US main

  deb-src $DEBIAN_MIRROR/ $DEBIAN_VERSION/updates main
  deb-src $DEBIAN_MIRROR/debian $DEBIAN_VERSION main
  deb-src $DEBIAN_MIRROR/debian-non-US $DEBIAN_VERSION/non-US main
EOF
  cp $0 $DEBIAN_VERSION-tarball/tmp/

  chroot $DEBIAN_VERSION-tarball/ /tmp/`basename $0` $DEBIAN_VERSION --chroot
  cd $DEBIAN_VERSION-tarball

  tar cvjf ../$DEBIAN_VERSION-tarball.tar.bz2 *
}

stage_remove_list()
{
  echo "Stage (Building the remove list)"
  echo "-----"

  find $DEBIAN_VERSION-tarball/ \
    -path '/dev' -prune \
    -o -path '/proc' -prune \
    -o -print | sed -e 's,^\.,,' | sort > debianize-debian.list
  find / \
    -path '/boot' -prune \
    -o -path '/tmp' -prune \
    -o -path '/dev' -prune \
    -o -path '/proc' -prune \
    -o -path '/root' -prune \
    -o -path '/home' -prune \
    -o -path '/var/run' -prune \
    -o -path '/var/log' -prune \
    -o -path '/var/local' -prune \
    -o -path '/usr/local' -prune \
    -o -path '/lib/modules' -prune \
    -o -print | sort > ~/debianize-redhat.list
  diff -u debianize-redhat.list debianize-debian.list | tail +2 | \
    grep '^-' | sed -e 's,^-,,' > debianize-remove.list
}

setup_network()
{
  echo "Stage (Setting up network)"
  echo "-----"

  . /etc/sysconfig/network

  for f in /etc/sysconfig/network-scripts/ifcfg-*; do
    unset DEVICE BROADCAST BOOTPROTO IPADDR NETMASK NETWORK ONBOOT

    . $f

    if [ "$ONBOOT" = "yes"  ]; then
      echo "auto $DEVICE"
    fi
    echo "iface $DEVICE inet $BOOTPROTO"
    if [ -z "$IPADDR" ]; then
      echo "  address $IPADDR"
    fi
    if [ -z "$BRADCAST" ]; then
      echo "  broadcast $BROADCAST"
    fi
    if [ -z "$NETMASK" ]; then
      echo "  netmask $NETMASK"
    fi
    if [ -z "$NETWORK" ]; then
      echo "  network $NETWORK"
    fi
    echo "  gateway $GATEWAY"
    echo ""
    echo
  done
}

stage_configure()
{
  echo "Stage (Configuring)"
  echo "-----"

  setup_network > /etc/network/interfaces

  passwd

  #Add a kernel paramater "panic=30"
  dpkg --configure -a
  update-modules
}

stage_dump()
{
  echo "Stage (Dump the tarball)"
  echo "-----"

  cd /
  tar czvf ~/redhat-etc.tgz /etc
  tar czvf ~/redhat-log.tgz /var/log
  tar xvf ~/$DEBIAN_VERSION-tarball.tar.bz2 --bzip2 -p -U --numeric-owner
  ldconfig
  hash -r
}

stage_trash()
{
  echo "Stage (Trash the old system)"
  echo "-----"

  cat ~/debianize-remove.list | xargs rm -f
  cat ~/debianize-remove.list | xargs rmdir -p
  hash -r
#  reboot # !!! DANGER WILL ROBINSON !!!
}

if [ "$1" = "--chroot" ]; then
  setup_chroot
  exit 0
fi

stage_tarball
stage_remove_list
stage_dump
stage_configure
stage_trash

exit 0

